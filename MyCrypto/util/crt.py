#!/usr/bin/python3
import sys

sys.path.append('../..')
from MyCrypto.util import inverse_mod
from MyCrypto.util import gcd
from functools import reduce


def crt(a, m):
    """chinese remain theory, get x from x % m = a"""
    M = 1
    for e in m:
        M = M * e
    inv = []
    for i in range(len(m)):
        inv.append(inverse_mod.inverse_mod(M // m[i], m[i]))
    sum_num = 0
    for i in range(len(m)):
        sum_num = sum_num + M // m[i] * inv[i] * a[i]
    return sum_num % M


def lcm(a, b):
    return a * b // gcd.gcd(a, b)


def excrt_onestep(A, B):
    """
    x % m = a
    externed crt, don't need m_i co_prime
    A, B: list, the first element is a, and the second one is m
    """
    A_a, A_m = A[0], A[1]
    B_a, B_m = B[0], B[1]
    d = gcd.gcd(A_m, B_m)
    if (A_a - B_a) % d != 0:
        print('Wrong')
        return
    else:
        dd, x, y = gcd.exgcd(A_m // d, B_m // d)
        return (A_a + (B_a - A_a) // d * x * A_m) % lcm(A_m, B_m), lcm(A_m, B_m)


def excrt(L):
    return reduce(excrt_onestep, L)[0]


if __name__ == '__main__':
    m = [
        [23, 28, 33], [23, 28, 33], [23, 28, 33],
        [
            489808178709479466279507878773770708214878979673,
            896234965496726578561614071442814700467907036641,
            1213827005758305602466882992172310409456053868843
        ],
        [
            13392316081651420877308875276166772808601812122052371442339078877740399569281672683820206196320955005869072002883847646526584107260355414977120453263391947,
            9734466939658282823343760206593283968765904848250021580218634383869090913086348857668999272399075016287736914000854272239315769632719896968098820774563511,
            9460200357790728398862913232664036038694521858415765931064505193755202156521446156499075450033429983317127589636591133111239548821251790171694322930011927
        ]
    ]
    a = [
        [0, 0, 0], [5, 20, 34], [283, 102, 23],
        [
            802310684485241212312289432691586430708135062249,
            961714109955647014172499578071923389425123540027,
            1381194006087304024683552712488022595194097928701
        ],
        [
            8157969540288411637818433039558323184074779086100165504668538221920170369774913261335059602331627321130656458962980224196880533337839226059601303464776145,
            9699616044315021194953572561076502992783130623216574220426043600142343504101508838526221359049417564415801914072315788919275792502477693022853881785198116,
            7832693802256371667866514213119452199821916193668106904135812283217637737600922381702016472708855675649121271702977408217814917908566132517503707494037556
        ]
    ]
    for i in range(5):
        a_l = a[i]
        m_l = m[i]
        print('a = {}, \nm = {}'.format(a_l, m_l))
        print(crt(a_l, m_l))
        print('\n')

    l = [[5, 23], [20, 28], [34, 33]]
    print(excrt(l))
